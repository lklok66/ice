<!--
 **********************************************************************

 Copyright (c) 2003-2008 ZeroC, Inc. All rights reserved.

 This copy of Ice-E is licensed to you under the terms described in the
 ICEE_LICENSE file included in this distribution.

 **********************************************************************
-->

<project name="demo_IceE_midp_chat" default="all" basedir=".">

    <!-- set global properties for this build -->
    <property name="top.dir" value="../../../.."/>

    <!-- Include common definitions -->
    <import file="${top.dir}/config/common.xml"/>

    <target name="init" depends="config-init"/>

    <target name="generate" depends="init">
        <!-- Create the output directory for generated code -->
        <mkdir dir="${generated.dir}"/>
        <slice2javae ice="on" outputdir="${generated.dir}">
	    <includepath>
		<pathelement path="../../jdk/chat" />
		<pathelement path="${slice.dir}" />
	    </includepath>
            <fileset dir="../../jdk/chat">
		<include name="Chat.ice"/>
		<include name="Router.ice"/>
		<include name="Session.ice"/>
	    </fileset>
        </slice2javae>
    </target>

    <target name="compile" depends="generate">
        <mkdir dir="${class.dir}"/>
	<javac srcdir="${generated.dir}" destdir ="${class.dir}"
            source="1.2" target="1.1" debug="${debug}">
	    <bootclasspath refid="midp.bootclasspath"/>  
 	    <classpath refid="midp.classpath"/>
	</javac>
        <javac srcdir="." destdir="${class.dir}" source="1.2" excludes="generated/**" debug="${debug}">
	    <bootclasspath refid="midp.bootclasspath"/>  
            <classpath>
	       <path refid="midp.classpath"/>
	       <pathelement path="classes"/>
	    </classpath>
        </javac>
    </target>

    <target name="jar" depends="compile">
	<mkdir dir="tmp"/>
	<manifest file="MANIFEST.MF">
	    <attribute name="Microedition-Configuration" value="CLDC-1.1"/>
	    <attribute name="MIDlet-Name" value="ChatDemo"/>
	    <attribute name="MIDlet-Vendor" value="ZeroC"/>
	    <attribute name="MIDlet-1" value="ChatMIDlet,,ChatMIDlet"/>
	    <attribute name="MIDlet-Version" value="1.0"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
        </manifest>

	<jar destfile="tmp/ChatDemo.jar" manifest="MANIFEST.MF" basedir="${class.dir}"/>
        <jar destfile="tmp/ChatDemo.jar" basedir="${midp.lib.dir}" excludes="IceE-midp.jar" update="true"/>
    </target>

    <target name="obfuscate" depends="jar" if="hasProguardAndMIDP">
	<taskdef resource="proguard/ant/task.properties"/>
	<move overwrite="true" file="tmp/ChatDemo.jar" tofile="tmp/ChatDemo_orig.jar"/>
	<proguard overloadaggressively="on" optimize="off" defaultpackage="" obfuscate="on"
	    allowaccessmodification="on" printseeds="off" usemixedcaseclassnames="off">
	    <injar file="tmp/ChatDemo_orig.jar"/>
	    <outjar file="tmp/ChatDemo.jar"/>
	    <libraryjar refid="wtklibs"/>
	    <keep access="public" extends="javax.microedition.midlet.MIDlet"/>
	    <keepclasseswithmembernames>
		<method access="native" />
	    </keepclasseswithmembernames>
	</proguard>
    </target>

    <target name="preverify" depends="obfuscate">
	<exec executable="${WTK}/bin/preverify">
	    <arg line="-classpath ${WTKLIBS}"/>
	    <arg line="-d ."/>
	    <arg line="tmp/ChatDemo.jar"/>
        </exec>
    </target>

    <target name="jad" depends="preverify">
	<length property="jarfile-length" file="ChatDemo.jar"/>
	<jadfile file="ChatDemo.jad">
	    <attribute name="MIDlet-Version" value="1.0"/>
            <attribute name="MIDlet-Vendor" value="ZeroC"/>
	    <attribute name="MIDlet-Jar-URL" value="ChatDemo.jar"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
	    <attribute name="MicroEdition-Configuration" value="CLDC-1.1"/>
	    <attribute name="MIDlet-1" value="ChatMIDlet,,ChatMIDlet"/>
	    <attribute name="MIDlet-Jar-Size" value="${jarfile-length}"/>
	    <attribute name="MIDlet-Name" value="ChatDemo"/>
	    <attribute name="MIDlet-Permissions" 
		value="javax.microedition.io.Connector.socket, javax.microedition.io.Connector.serversocket"/>
        </jadfile>
    </target>

    <target name="prc" depends="jad">
        <!-- jartoprc is a tool included with IBM's WME Developer Toolkit that converts
	     MIDlets into a PalmOS resource file (PRC). We have to remove JAVA_HOME when
	     running this program. -->
	<exec executable="D:/WEMEDev/Tools/bin/jartoprc" newenvironment="true">
	    <arg line="-jad:ChatDemo.jad"/>
	    <arg line="-highRes"/>
	    <arg line="-id:ZROC"/>
	    <arg line="-name:ChatDemo"/>
	    <env key="JAVA_HOME" value=""/>
        </exec>
    </target>

    <target name="all" depends="jad"/>

    <target name="clean">
	<delete dir="${class.dir}"/>
	<delete dir="${generated.dir}"/>
	<delete dir="tmp"/>
	<delete quiet="true" file="ChatDemo.jar"/>
	<delete quiet="true" file="ChatDemo.jad"/>
	<delete quiet="true" file="ChatDemo.prc"/>
	<delete quiet="true" file="MANIFEST.MF"/>
    </target>

</project>
