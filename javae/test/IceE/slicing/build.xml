<!--
 **********************************************************************

 Copyright (c) 2003-2007 ZeroC, Inc. All rights reserved.

 This copy of Ice-E is licensed to you under the terms described in the
 ICEE_LICENSE file included in this distribution.

 **********************************************************************
-->

<project name="test_IceE_slicing" default="all" basedir=".">

    <!-- set global properties for this build -->
    <property name="top.dir" value="../../.."/>

    <!-- Include common definitions -->
    <import file="${top.dir}/config/common.xml"/>

    <target name="init" depends="config-init"/>

    <property name="cclass.dir" value="cclasses"/>
    <property name="sclass.dir" value="sclasses"/>
    <property name="midp.cclass.dir" value="midpclient"/>
    <property name="midp.sclass.dir" value="midpserver"/>

    <property name="cgen.dir" value="cgenerated"/>
    <property name="sgen.dir" value="sgenerated"/>
    <property name="csrc.dir" value="csrc"/>
    <property name="ssrc.dir" value="ssrc"/>

    <target name="generate" depends="init">
        <!-- Create the output directory for generated code -->
        <mkdir dir="${cgen.dir}"/>
        <slice2javae outputdir="${cgen.dir}">
	    <includepath>
		<pathelement path="."/>
	    </includepath>
            <fileset dir="." includes="Test.ice"/>
        </slice2javae>
        <mkdir dir="${sgen.dir}"/>
        <slice2javae outputdir="${sgen.dir}">
	    <includepath>
		<pathelement path="."/>
	    </includepath>
            <fileset dir="." includes="Test.ice"/>
        </slice2javae>
        <mkdir dir="${sgen.dir}"/>
        <slice2javae outputdir="${sgen.dir}">
	    <includepath>
		<pathelement path="."/>
	    </includepath>
            <fileset dir="${ssrc.dir}" includes="ServerPrivate.ice"/>
        </slice2javae>
    </target>

    <target name="compile" depends="generate">
        <mkdir dir="${cclass.dir}"/>
        <javac srcdir="${cgen.dir}" destdir="${cclass.dir}" classpath="${jdk.lib.dir}/IceE.jar" debug="${debug}"
	    source="1.2" target="1.1"/>
        <javac srcdir="${csrc.dir}" destdir="${cclass.dir}" classpath="${jdk.lib.dir}/IceE.jar"
            debug="${debug}" source="1.2" target="1.1">
            <exclude name="${cgen.dir}/**" />
            <exclude name="**/*MIDlet*" />
        </javac>
        <mkdir dir="${sclass.dir}"/>
        <javac srcdir="${sgen.dir}" destdir="${sclass.dir}" classpath="${jdk.lib.dir}/IceE.jar" debug="${debug}"
	    source="1.2" target="1.1"/>
        <javac srcdir="${ssrc.dir}" destdir="${sclass.dir}" classpath="${jdk.lib.dir}/IceE.jar"
            debug="${debug}" source="1.2" target="1.1">
            <exclude name="${sgen.dir}/**" />
            <exclude name="**/*MIDlet*" />
        </javac>
    </target>

    <target name="midp-compile" depends="generate" if="midp">
        <mkdir dir="${midp.cclass.dir}"/>
        <javac srcdir="${cgen.dir}" destdir="${midp.cclass.dir}" classpath="${midp.lib.dir}" debug="${debug}"
	    source="1.2" target="1.1"/>
        <javac srcdir="${csrc.dir}" destdir="${midp.cclass.dir}" classpath="${midp.lib.dir}" excludes="${cgen.dir}/**"
            classpathref="midp.classpath" bootclasspathref="midp.bootclasspath" 
            debug="${debug}" source="1.2" target="1.1">
            <src path="${csrc.dir}" />
            <src path="../common" />
            <exclude name="**/ServerBase.java" />
            <exclude name="**/Collocated*" />
        </javac>
        <mkdir dir="${midp.sclass.dir}"/>
        <javac srcdir="${sgen.dir}" destdir="${midp.sclass.dir}" classpath="${midp.lib.dir}" debug="${debug}"
            source="1.2" target="1.1"/>
        <javac destdir="${midp.sclass.dir}" classpath="${midp.lib.dir}" excludes="${sgen.dir}/**"
            classpathref="midp.classpath" bootclasspathref="midp.bootclasspath" 
            debug="${debug}" source="1.2" target="1.1">
            <src path="${ssrc.dir}" />
            <src path="../common" />
            <exclude name="**/ClientBase.java" />
            <exclude name="**/Collocated*" />
        </javac>
    </target>

    <property name="testclient" value="SliceClient"/>
    <property name="testserver" value="SliceServer"/>

    <target name="client-midlet-jar" depends="midp-compile" if="midp">
        <mkdir dir="tmp"/>
	<manifest file="CLIENTMANIFEST.MF">
	    <attribute name="Microedition-Configuration" value="CLDC-1.1"/>
            <attribute name="MIDlet-Vendor" value="ZeroC"/>
	    <attribute name="MIDlet-Version" value="1.0"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
	    <attribute name="MIDlet-Name" value="${testclient}Test"/>
        </manifest>

	<copy overwrite="true" file="config" todir="${midp.cclass.dir}"/>
	<jar destfile="tmp/${testclient}.jar" manifest="CLIENTMANIFEST.MF" basedir="${midp.cclass.dir}"/>
        <jar destfile="tmp/${testclient}.jar" manifest="CLIENTMANIFEST.MF" basedir="${midp.lib.dir}" update="true"
            excludes="IceE-midp.jar"/>
    </target>

    <target name="obfuscate-client" depends="client-midlet-jar" if="hasProguardAndMIDP">
	<taskdef resource="proguard/ant/task.properties"/>
	<move overwrite="true" file="tmp/${testclient}.jar" tofile="tmp/${testclient}_orig.jar"/>
	<proguard overloadaggressively="on" optimize="off" defaultpackage="" obfuscate="off"
	    allowaccessmodification="on" printseeds="off" usemixedcaseclassnames="off">
	    <injar file="tmp/${testclient}_orig.jar"/>
	    <outjar file="tmp/${testclient}.jar"/>
	    <libraryjar refid="wtklibs"/>
	    <keep access="public" extends="javax.microedition.midlet.MIDlet"/>
	    <keepclasseswithmembernames>
		<method access="native" />
	    </keepclasseswithmembernames>
            <keep name="Ice.**">
                <method access="public"/>
            </keep>
	</proguard>
    </target>

    <target name="preverify-client" depends="obfuscate-client" if="midp">
        <exec executable="${WTK}/bin/preverify">
           <arg line="-classpath ${WTKLIBS}"/>
            <arg line="-d ."/>
	    <arg line="tmp/${testclient}.jar"/>
	</exec>
    </target>

    <target name="client-midlet" depends="preverify-client" if="midp">
	<length property="clientjarfile-length" file="${testclient}.jar"/>
	<jadfile file="${testclient}.jad">
	    <attribute name="MIDlet-Version" value="1.0"/>
            <attribute name="MIDlet-Vendor" value="ZeroC"/>
	    <attribute name="MIDlet-Jar-URL" value="${testclient}.jar"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
	    <attribute name="MicroEdition-Configuration" value="CLDC-1.1"/>
	    <attribute name="MIDlet-1" value="Client, ,ClientMIDlet"/>
	    <attribute name="MIDlet-Jar-Size" value="${clientjarfile-length}"/>
	    <attribute name="MIDlet-Name" value="${testclient}Test"/>
	    <attribute name="MIDlet-Permissions" 
		value="javax.microedition.io.Connector.socket, javax.microedition.io.Connector.serversocket"/>
        </jadfile>
    </target>

    <target name="server-midlet-jar" depends="midp-compile" if="midp">
        <mkdir dir="tmp"/>
	<manifest file="MANIFEST.MF">
	    <attribute name="Microedition-Configuration" value="CLDC-1.1"/>
            <attribute name="MIDlet-Vendor" value="ZeroC"/>
	    <attribute name="MIDlet-Version" value="1.0"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
	    <attribute name="MIDlet-Name" value="${testserver}Test"/>
        </manifest>

	<jar destfile="tmp/${testserver}.jar" manifest="MANIFEST.MF" basedir="${midp.sclass.dir}"/>
        <jar destfile="tmp/${testserver}.jar" manifest="MANIFEST.MF" basedir="${midp.lib.dir}" update="true"
            excludes="IceE-midp.jar"/>
    </target>

    <target name="obfuscate-server" depends="server-midlet-jar" if="hasProguardAndMIDP">
	<taskdef resource="proguard/ant/task.properties"/>
	<move overwrite="true" file="tmp/${testserver}.jar" tofile="tmp/${testserver}_orig.jar"/>
	<proguard overloadaggressively="on" optimize="off" defaultpackage="" obfuscate="off"
	    allowaccessmodification="on" printseeds="off">
	    <injar file="tmp/${testserver}_orig.jar"/>
	    <outjar file="tmp/${testserver}.jar"/>
	    <libraryjar refid="wtklibs"/>
	    <keep access="public" extends="javax.microedition.midlet.MIDlet"/>
	    <keepclasseswithmembernames>
		<method access="native" />
	    </keepclasseswithmembernames>
            <keep name="Ice.**">
                <method access="public"/>
            </keep>
	</proguard>
    </target>

    <target name="preverify-server" depends="obfuscate-server" if="midp">
        <exec executable="${WTK}/bin/preverify">
           <arg line="-classpath ${WTKLIBS}"/>
            <arg line="-d ."/>
	    <arg line="tmp/${testserver}.jar"/>
	</exec>
    </target>

    <target name="server-midlet" depends="preverify-server" if="midp">
	<length property="jarfile-length" file="${testserver}.jar"/>
	<jadfile file="${testserver}.jad">
	    <attribute name="MIDlet-Version" value="1.0"/>
            <attribute name="MIDlet-Vendor" value="ZeroC"/>
	    <attribute name="MIDlet-Jar-URL" value="${testserver}.jar"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
	    <attribute name="MicroEdition-Configuration" value="CLDC-1.1"/>
	    <attribute name="MIDlet-1" value="Server, , ServerMIDlet"/>
	    <attribute name="MIDlet-Jar-Size" value="${jarfile-length}"/>
	    <attribute name="MIDlet-Name" value="${testserver}Test"/>
	    <attribute name="MIDlet-Permissions" 
		value="javax.microedition.io.Connector.socket, javax.microedition.io.Connector.serversocket"/>
        </jadfile>
    </target>

    <target name="midlets" depends="server-midlet, client-midlet" if="midp"/>

    <target name="all" depends="compile, midlets"/>

    <target name="clean">
        <delete dir="${cgen.dir}"/>
        <delete dir="${sgen.dir}"/>
        <delete dir="${cclass.dir}"/>
        <delete dir="${sclass.dir}"/>
	<delete dir="${midp.cclass.dir}"/>
	<delete dir="${midp.sclass.dir}"/>
        <delete dir="tmp"/>
	<delete quiet="true" file="${testclient}.jar"/>
	<delete quiet="true" file="${testclient}.jad"/>
	<delete quiet="true" file="${testserver}.jar"/>
	<delete quiet="true" file="${testserver}.jad"/>
	<delete quiet="true" file="CLIENTMANIFEST.MF"/>
	<delete quiet="true" file="MANIFEST.MF"/>
    </target>

</project>
