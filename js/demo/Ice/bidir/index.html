<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bidir Demo | Ice for JavaScript</title>
    <link rel="stylesheet" href="../../../config/foundation/css/foundation.css" />
    <script src="../../../config/foundation/js/modernizr.js"></script>
    <script src="../../../lib/Ice.js"></script>
    <script src="Callback.js"></script>
    
    <style type="text/css">
        #ssl
        {
            margin-top:10px;
        }
    </style>
  </head>
  <body>
    <nav class="top-bar" data-topbar>
        <ul class="title-area">
            <li class="name">
                <h1><a href="../../../index.html">Ice for JavaScript</a></h1>
            </li>
        </ul>
    </nav>
    <section role="main">
        <ul class="breadcrumbs">
            <li><a href="../../../index.html">Ice</a></li>
            <li><a href="../../index.html">Demos</a></li>
            <li class="current"><a href="#">Bidir</a></li>
        </ul>
        <div class="row">
            <div class="large-12 medium-12 columns">
                <form>
                    <br/>
                    <div class="row">
                        <div class="small-3 columns">
                            <label class="right inline" for="hostname">Hostname:</label>
                        </div>
                        <div class="small-9 columns">
                            <input type="text" id="hostname"/>
                        </div>
                    </div>
                </form>
                <a href="#" class="button small" id="start">Start</a>
                <a href="#" class="button small disabled" id="stop">Stop</a>
                <form>
                    <textarea id="console" class="disabled" readonly></textarea>
                </form>
            </div>
        </div>
    </section>
    <script src="../../../config/foundation/js/jquery.js"></script>
    <script src="../../../config/foundation/js/foundation.min.js"></script>
    <script type="application/javascript">
    
        var Promise = Ice.Promise;
        var CallbackSenderPrx = Demo.CallbackSenderPrx;
        
        $(document).foundation();
      
        $(document).ready(function(){
            $("#hostname").attr("placeholder", document.location.hostname || "127.0.0.1");
            
            //
            // Define a servant class that implements Demo.CallbackReceiver
            // interface.
            //
            var CallbackReceiverI = Ice.Class(Demo.CallbackReceiver, {
                callback: function(num, current)
                {
                    var s = $("#console").val();
                    var msg = "received callback #" + num;
                    $("#console").val(s ? s + "\n" + msg : msg);
                    $("#console").scrollTop($("#console").get(0).scrollHeight);
                }
            });
            
            var id = new Ice.InitializationData();
            id.properties = Ice.createProperties();
            //
            // Client-side ACM must be disabled for bidirectional connections.
            //
            id.properties.setProperty("Ice.ACM.Client", "0");

            var communicator;
            
            $("#start").click(
                function()
                {
                    if(!$(this).hasClass("disabled"))
                    {
                        
                        $(this).addClass("disabled");
                        $("#stop").removeClass("disabled");
                        $("#console").val("");
                        
                        var ident = new Ice.Identity(Ice.UUID.generateUUID(), "");
                        Promise.try(
                            function()
                            {
                                communicator = Ice.initialize(id);
                                var hostname = $("#hostname").val() || $("#hostname").attr("placeholder");
                                return communicator.stringToProxy("sender:ws -p 10000 -h " + hostname);
                            }
                        ).then(
                            function(proxy)
                            {
                                return CallbackSenderPrx.checkedCast(proxy).then(
                                    function(r, server)
                                    {
                                        return communicator.createObjectAdapter("").then(
                                            function(r, adapter)
                                            {
                                                adapter.add(new CallbackReceiverI(), ident);
                                                return adapter.activate().then(
                                                    function(asyncResult)
                                                    {
                                                        return server.ice_getConnection();
                                                    }
                                                ).then(
                                                    function(asyncResult, conn)
                                                    {
                                                        conn.setAdapter(adapter);
                                                        return server.addClient(ident);
                                                    }
                                                );
                                            });
                                    });
                            }
                        ).exception(
                            function(ex)
                            {
                                $("#console").val(ex.toString());
                                Promise.try(
                                    function()
                                    {
                                        if(communicator)
                                        {
                                            return communicator.destroy();
                                        }
                                    }
                                ).finally(
                                    function()
                                    {
                                        $("#stop").addClass("disabled");
                                        $("#start").removeClass("disabled");
                                    });
                            }
                        );
                    }
                    return false;
                });
                
            $("#stop").click(
                function()
                {
                    if(!$(this).hasClass("disabled"))
                    {
                        $(this).addClass("disabled");
                        Promise.try(
                            function()
                            {
                                if(communicator)
                                {
                                    return communicator.destroy();
                                }
                            }
                        ).finally(
                            function()
                            {
                                $("#stop").addClass("disabled");
                                $("#start").removeClass("disabled");
                            }
                        );
                    }
                });
        });
    </script>
  </body>
</html>
